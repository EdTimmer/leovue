<html>
<head>
  <style type="text/css">
    BODY {
      font-family: Verdana;
    }
    .level3 {
      margin-left: 15px;
    }
    .level4 {
       margin-left: 30px;
    }
    .level5 {
      margin-left: 45px;
    }
    .level6 {
      margin-left: 60px;
    }
    .level7 {
      margin-left: 75px;
    }
    DIV {
      margin-top: 8px
    }
  </style>
</head>
<body>
<div class='content'><div class="text">app.directive('initializerBuilder', function ($parse, FormioUtils) {
  return {
    restrict: 'E',
    scope: {
      initializerData: '='
    },
    template: '' +
    '<div>' +
    '  <div class="row">' +
    '    <div class="col-xs-6">' +
    '      <h5>Inputs</h5>' +
    '      <div class="hotInputs" />' +
    '    </div>' +
    '    <div class="col-xs-6">' +
    '      <h5>Outputs</h5>' +
    '      <div class="hotOutputs" />' +
    '    </div>' +
    '  </div>' +
    '</div>',
    link: function (scope, element) {
      var initializerData = scope.initializerData;
      var components = [];
      var fields = [];
      FormioUtils.eachComponent(scope.$parent.form.components, function (component) {
        // Only add input elements.
        if (['button', 'initializer'].indexOf(component.type) === -1 && component.key.indexOf('panel') !== 0) {
          components.push(component);
          fields.push(component.key);
        }
      }, true);
      fields.push('buttonClick');
      scope.saveData = function () {
        if (initializerData.dataInputObject == undefined) {
          return;
        } // jshint ignore:line
        initializerData.dataOutputObject = getTableData(hotOutputs);
        initializerData.dataInputObject = getTableData(hotInputs);

        scope.initializerData = initializerData;

      };

      function getTableData(hotTable) {
        var cellData = hotTable.getData();
        var headerData = hotTable.getColHeader();
        var dataTable = [];
        for (var k = 0; k < cellData.length; k++) {
          var dataRow = {};
          if (!hotTable.isEmptyRow(k)) {
            for (var i = 0; i < cellData[k].length; i++) {
              var key = headerData[i];
              var cellValue = cellData[k][i];

              if (cellValue === null) {
                cellValue = '';
              }

              dataRow[key] = cellValue;
            }
            dataTable.push(dataRow);
          }
        }
        return dataTable;
      }

      scope.loadData = function (initializerData) {

        if (initializerData.dataInputObject === undefined) {
          return;
        }
        hotInputs.updateSettings({
          data: initializerData.dataInputObject
        });
        hotOutputs.updateSettings({
          data: initializerData.dataOutputObject
        });
      };

      var hotInputElement = element[0].querySelector('.hotInputs');
      var hotInputSettings = {
        data: initializerData.dataInputObject,
        columns: [
          {
            data: 'id',
            type: 'autocomplete',
            source: fields.sort(),
            strict: false
          },
          {
            data: 'required',
            type: 'checkbox'
          }

        ],
        colWidths: [250, 85],
        rowHeights: 23,
        // performance tip: turn off calculations
        autoWrapRow: true,
        height: 200,
        rowHeaders: false,
        colHeaders: [
          'id', 'required'
        ],
        manualColumnResize: true,
        dropdownMenu: false,
        minSpareRows: 4,
        stretchH: 'all'
      };

      var hotInputs = new Handsontable(hotInputElement, hotInputSettings);

      var hotOutputElement = element[0].querySelector('.hotOutputs');
      var hotOutputSettings = {
        data: initializerData.dataOutputObject,
        columns: [
          {
            data: 'id',
            type: 'autocomplete',
            source: fields.sort(),
            strict: false
          },
          {
            data: 'type',
            type: 'dropdown',
            source: ['value', 'minimum', 'maximum', 'steps', 'visible', 'required', 'disabled', 'message', 'clicked', 'page', 'requiredAndVisible', 'pattern', 'label', 'content', 'customClass', 'trigger']
          },
          {
            data: 'value',
            type: 'text'
          }
        ],
        colWidths: [150, 100, 200],
        rowHeights: 23,
        // performance tip: turn off calculations
        autoWrapRow: true,
        height: 200,
        rowHeaders: false,
        colHeaders: [
          'id',
          'type',
          'value'
        ],
        manualColumnResize: true,
        dropdownMenu: false,
        minSpareRows: 4,
        stretchH: 'all'
      };

      var hotOutputs = new Handsontable(hotOutputElement, hotOutputSettings);

      angular.element(function () {
        hotInputs.render();
        hotOutputs.render();
      });

    },
    controller: [
      '$scope',
      function ($scope) {
        $scope.$watch('initializerData', function (newData) {
          $scope.loadData(newData);
        });
      }
    ]
  };
});
</div></div>
</body>
</html>
