<html>
<header>

</header>
<body>
<div class='content'><pre><span class="hljs-keyword">import</span> <span class="hljs-built_in">escape</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'escape-html'</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadDoc</span> (<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'loading file:'</span>, filename)
  <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    axios.get(filename)
      .then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">response</span>) </span>{
        resolve(response.data)
      })
      .catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
        <span class="hljs-built_in">console</span>.log(error)
        reject()
      })
  })
  <span class="hljs-keyword">return</span> p
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanText</span>(<span class="hljs-params">data, startId</span>)</span>{
  data.name = data.name.replace(<span class="hljs-regexp">/«/g</span>, <span class="hljs-string">'\u00AB'</span>)
  data.name = data.name.replace(<span class="hljs-regexp">/»/g</span>, <span class="hljs-string">'\u00BB'</span>)
  data.name = data.name.replace(<span class="hljs-regexp">/'/g</span>, <span class="hljs-string">'\x27'</span>)
  data.name = data.name.replace(<span class="hljs-regexp">/"/g</span>, <span class="hljs-string">'\x22'</span>)
  <span class="hljs-comment">//data.name = escape(data.name)</span>
  data.name = data.name.replace(<span class="hljs-regexp">/&amp;#39;/g</span>,<span class="hljs-string">'\x27'</span>)
  data.id = data.id + <span class="hljs-string">''</span>; <span class="hljs-comment">// probably unneeded now</span>
  <span class="hljs-keyword">let</span> children = data.children;
  <span class="hljs-keyword">if</span> (!children) { <span class="hljs-keyword">return</span> }
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; children.length; i++){
    cleanText(children[i], startId)
  }
  data.t = data.t.replace(<span class="hljs-regexp">/^.*?_/</span>,<span class="hljs-string">''</span>)
  <span class="hljs-keyword">if</span> (startId) {
    data.t = startId + <span class="hljs-string">'-'</span> + data.t + <span class="hljs-string">''</span>
  }
}
<span class="hljs-comment">/**
 * <span class="hljs-doctag">TODO:</span> move to util, also is in store/index, review logic for relative / subtrees
 * Is url relative
 * @param url {string}
 * @returns {boolean} - if is relative
 */</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRelative</span> (<span class="hljs-params">url</span>) </span>{
  <span class="hljs-keyword">var</span> ok = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-regexp">/^http/</span>.test(url)) {
    ok = <span class="hljs-literal">false</span>
  }
  <span class="hljs-keyword">return</span> ok
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getLeoJSON</span> (<span class="hljs-params">filename, id</span>) </span>{
  <span class="hljs-keyword">if</span> (filename.indexOf(<span class="hljs-string">'#'</span>) &gt; <span class="hljs-number">0</span>) {
    filename = filename.substring(<span class="hljs-number">0</span>, filename.indexOf(<span class="hljs-string">'#'</span>))
  }
  <span class="hljs-keyword">var</span> p = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!filename.match(<span class="hljs-regexp">/static/</span>) &amp;&amp; isRelative(filename)) {
      filename = <span class="hljs-string">'static/'</span> + filename
    }
    <span class="hljs-keyword">if</span> (!filename.match(<span class="hljs-regexp">/\.leo$/</span>)) {
      filename = filename + <span class="hljs-string">'.leo'</span>
    }
    loadDoc(filename, <span class="hljs-string">'Text'</span>)
      .then(<span class="hljs-function"><span class="hljs-params">xmlString</span> =&gt;</span> {
        resolve(transformLeoXML(xmlString, id))
      })
  })
  <span class="hljs-keyword">return</span> p
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">transformLeoXML</span> (<span class="hljs-params">xmlString, startId</span>) </span>{
    <span class="hljs-keyword">const</span> oParser = <span class="hljs-keyword">new</span> DOMParser()
    <span class="hljs-keyword">const</span> xml = oParser.parseFromString(xmlString, <span class="hljs-string">'text/xml'</span>)
    <span class="hljs-keyword">const</span> tnodes = xml.getElementsByTagName(<span class="hljs-string">'t'</span>)
    <span class="hljs-keyword">let</span> textItems = {}
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; tnodes.length; i++){
      <span class="hljs-keyword">let</span> el = tnodes[i]
      <span class="hljs-keyword">let</span> elText = el.textContent
      <span class="hljs-keyword">let</span> a = el.getAttribute(<span class="hljs-string">'tx'</span>)
      a = a.replace(<span class="hljs-regexp">/\./g</span>,<span class="hljs-string">'_'</span>)
      a = a.replace(<span class="hljs-regexp">/^.*?_/</span>,<span class="hljs-string">''</span>)
      <span class="hljs-keyword">if</span> (startId) {
        a = startId + <span class="hljs-string">'-'</span> + a
      }
      <span class="hljs-keyword">if</span> (
         (<span class="hljs-regexp">/^@language /</span>.test(elText)) &amp;&amp;
         (!<span class="hljs-regexp">/^@language html/</span>.test(elText)) &amp;&amp;
         (!<span class="hljs-regexp">/^@language md/</span>.test(elText))
      ){
        <span class="hljs-comment">// elText = escape(elText)</span>
      }
      textItems[a] = elText
      <span class="hljs-comment">// h</span>
    }
    <span class="hljs-keyword">const</span> vnodes = xml.getElementsByTagName(<span class="hljs-string">'v'</span>)
    <span class="hljs-keyword">let</span> pid
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; vnodes.length; i++) {
      pid = i + <span class="hljs-number">1</span>
      <span class="hljs-keyword">if</span> (startId) {
        pid = startId + <span class="hljs-string">'-'</span> + pid
      }
      vnodes[i].setAttribute(<span class="hljs-string">'id'</span>, <span class="hljs-string">'"'</span> +pid + <span class="hljs-string">'"'</span>)
    }
    <span class="hljs-keyword">var</span> scripts = <span class="hljs-built_in">document</span>.getElementsByTagName(<span class="hljs-string">'script'</span>),
        str     = <span class="hljs-string">''</span>,
        i       = <span class="hljs-number">0</span>,
        il      = scripts.length;
    <span class="hljs-keyword">for</span> (; i&lt;il; i++) {
      <span class="hljs-keyword">if</span> (scripts[i].type === <span class="hljs-string">'leo/xsl-template'</span>) str += scripts[i].innerHTML;
    }
    <span class="hljs-keyword">const</span> xsl = oParser.parseFromString(str, <span class="hljs-string">'text/xml'</span>)
    <span class="hljs-keyword">const</span> xsltProcessor = <span class="hljs-keyword">new</span> XSLTProcessor()
    xsltProcessor.importStylesheet(xsl)
    <span class="hljs-keyword">const</span> resultDocument = xsltProcessor.transformToFragment(xml, <span class="hljs-built_in">document</span>)
    <span class="hljs-keyword">let</span> data = resultDocument.textContent
    data = data.replace(<span class="hljs-regexp">/,\s?$/</span>, <span class="hljs-string">''</span>) <span class="hljs-comment">// kludge to get rid of trailing comma</span>
    data = <span class="hljs-string">'['</span> + data + <span class="hljs-string">']'</span>
    data = <span class="hljs-built_in">JSON</span>.parse(data)
    data.forEach(<span class="hljs-function"><span class="hljs-params">d</span> =&gt;</span> cleanText(d, startId))
    <span class="hljs-keyword">const</span> xdata = {}
    xdata.data = data
    xdata.textItems = textItems
    <span class="hljs-keyword">return</span> xdata
}

<span class="hljs-keyword">export</span> {getLeoJSON, transformLeoXML}
</pre></div></body>
</html>
